<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>X√°c nh·∫≠n ƒë∆°n h√†ng</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script>
        function updateGiamGia() {
            const select = document.getElementById("maGiamGia");
            const selectedOption = select.options[select.selectedIndex];
            const giamGiaText = document.getElementById("giamGiaText");
            const tongTienHang = parseInt(document.getElementById("tongTienHangHidden").value);
            const phiVanChuyen = parseInt(document.getElementById("phiVanChuyenHidden").value);
            let giam = 0;

            if (selectedOption.dataset.loai === 'phantram') {
                giam = tongTienHang * parseInt(selectedOption.dataset.value) / 100;
            } else if (selectedOption.dataset.loai === 'tien') {
                giam = parseInt(selectedOption.dataset.value);
            }

            giamGiaText.innerText = giam.toLocaleString('vi-VN') + ' ƒë';
            const tongThanhToan = tongTienHang + phiVanChuyen - giam;
            document.getElementById("tongThanhToanText").innerText = tongThanhToan.toLocaleString('vi-VN') + ' ƒë';
            document.getElementById("tongThanhToanHiddenField").value = tongThanhToan;
        }

        function toggleVnpay(radio) {
            const vnpayDiv = document.getElementById("vnpayInfo");
            const form = document.getElementById("xacNhanMuaHangForm");

            if (radio.id === "tt4") {
                vnpayDiv.style.display = "block";
                form.action = "/thanh-toan-vnpay";
            } else {
                vnpayDiv.style.display = "none";
                form.action = "/mua-hang";
            }

            console.log("üîÅ Form action set to:", form.action); // ‚úÖ Debug log
        }

        window.onload = function () {
            updateGiamGia();

            // ‚úÖ G√°n l·∫°i form action ƒë√∫ng n·∫øu radio ƒë√£ ch·ªçn
            const selectedRadio = document.querySelector('input[name="phuongThucThanhToan"]:checked');
            if (selectedRadio) {
                toggleVnpay(selectedRadio);
            }
        }
    </script>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">X√°c nh·∫≠n ƒë∆°n h√†ng</h2>

    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong>T√™n kh√°ch h√†ng:</strong>
                <span th:text="${nguoiDung.hoTen}"></span> <br>
                <strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong>
                <span th:if="${diaChiMacDinh != null}"
                      th:text="${diaChiMacDinh.diaChi} + ', ' + ${diaChiMacDinh.phuongXa} + ', ' + ${diaChiMacDinh.quanHuyen} + ', ' + ${diaChiMacDinh.tinhThanh}"></span>
                <span th:if="${diaChiMacDinh == null}" class="text-danger">Ch∆∞a c√≥ ƒë·ªãa ch·ªâ giao h√†ng m·∫∑c ƒë·ªãnh!</span>
            </div>
            <div>
                <a href="/dia-chi-giao-hang" class="btn btn-outline-primary btn-sm" title="Th√™m/Thay ƒë·ªïi ƒë·ªãa ch·ªâ">+</a>
            </div>
        </div>
    </div>

    <form id="xacNhanMuaHangForm" th:action="@{/mua-hang}" method="post">
        <input type="hidden" id="tongTienHangHidden" th:value="${tongTienHang}"/>
        <input type="hidden" id="phiVanChuyenHidden" th:value="${phiVanChuyen}"/>
        <input type="hidden" id="tongThanhToanHiddenField" name="tongThanhToan" th:value="${tongThanhToan}"/>

        <!-- M√£ gi·∫£m gi√° -->
        <div class="mb-3">
            <label for="maGiamGia" class="form-label">M√£ gi·∫£m gi√°:</label>
            <select name="maGiamGia" id="maGiamGia" class="form-select" onchange="updateGiamGia()">
                <option value="">-- Kh√¥ng ch·ªçn --</option>
                <option th:each="mg : ${danhSachMaGiamGia}"
                        th:value="${mg.id}"
                        th:data-loai="${mg.loaiGiam == 'phan_tram' ? 'phantram' : 'tien'}"
                        th:data-value="${mg.loaiGiam == 'phan_tram' ? mg.phanTramGiam : mg.soTienGiam}"
                        th:text="${mg.ma} + ' - ' + ${mg.moTa}">
                </option>
            </select>
        </div>

        <table class="table table-bordered">
            <thead class="table-light">
            <tr>
                <th>#</th>
                <th>S·∫£n ph·∫©m</th>
                <th>M√†u</th>
                <th>K√≠ch c·ª°</th>
                <th>·∫¢nh</th>
                <th>Gi√°</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>Th√†nh ti·ªÅn</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="sp, stat : ${danhSachSanPham}">
                <td th:text="${stat.index + 1}"></td>
                <td th:text="${sp.sanPhamChiTiet.sanPham.tenSanPham}"></td>
                <td th:text="${sp.sanPhamChiTiet.mauSac.tenMau}"></td>
                <td th:text="${sp.sanPhamChiTiet.kichCo.tenKichCo}"></td>
                <td><img th:src="@{'/images/' + ${sp.sanPhamChiTiet.sanPham.anhDaiDien}}" style="height: 50px;"></td>
                <td th:text="${sp.sanPhamChiTiet.gia} + ' ƒë'"></td>
                <td th:text="${sp.soLuong}"></td>
                <td th:text="${sp.soLuong * sp.sanPhamChiTiet.gia} + ' ƒë'"></td>
            </tr>
            </tbody>
            <tfoot>
            <tr>
                <td colspan="7" class="text-end fw-bold">T·ªïng ti·ªÅn h√†ng:</td>
                <td th:text="${tongTienHang} + ' ƒë'" class="fw-bold"></td>
            </tr>
            <tr>
                <td colspan="7" class="text-end fw-bold">Ph√≠ v·∫≠n chuy·ªÉn:</td>
                <td th:text="${phiVanChuyen} + ' ƒë'" class="fw-bold"></td>
            </tr>
            <tr>
                <td colspan="7" class="text-end fw-bold">Gi·∫£m gi√°:</td>
                <td><span id="giamGiaText">--</span></td>
            </tr>
            <tr>
                <td colspan="7" class="text-end fw-bold text-danger">T·ªïng thanh to√°n:</td>
                <td><span id="tongThanhToanText" th:text="${tongThanhToan} + ' ƒë'" class="fw-bold text-danger"></span></td>
            </tr>
            </tfoot>
        </table>

        <!-- H√¨nh th·ª©c thanh to√°n -->
        <div class="mb-3">
            <label class="form-label">H√¨nh th·ª©c thanh to√°n:</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="phuongThucThanhToan" id="tt1"
                       value="Thanh to√°n khi nh·∫≠n h√†ng" onclick="toggleVnpay(this)">
                <label class="form-check-label" for="tt1">Thanh to√°n khi nh·∫≠n h√†ng</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="phuongThucThanhToan" id="tt2"
                       value="Chuy·ªÉn kho·∫£n ng√¢n h√†ng" onclick="toggleVnpay(this)">
                <label class="form-check-label" for="tt2">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="phuongThucThanhToan" id="tt3"
                       value="V√≠ ƒëi·ªán t·ª≠" onclick="toggleVnpay(this)">
                <label class="form-check-label" for="tt3">V√≠ ƒëi·ªán t·ª≠</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="phuongThucThanhToan" id="tt4"
                       value="Chuy·ªÉn kho·∫£n VNPay" onclick="toggleVnpay(this)">
                <label class="form-check-label" for="tt4">Chuy·ªÉn kho·∫£n ng√¢n h√†ng qua VNPay</label>
            </div>

            <div id="vnpayInfo" class="p-3 border rounded bg-light mt-3" style="display: none;">
                <h5>Thanh to√°n qua VNPay</h5>
                <p>Khi b·∫•m x√°c nh·∫≠n, b·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang c·ªïng thanh to√°n VNPay ƒë·ªÉ ho√†n t·∫•t giao d·ªãch.</p>
            </div>
        </div>

        <button type="submit" class="btn btn-success">X√°c nh·∫≠n mua h√†ng</button>
        <a href="/gio-hang" class="btn btn-secondary">Quay l·∫°i gi·ªè h√†ng</a>
    </form>
</div>
</body>
</html>
